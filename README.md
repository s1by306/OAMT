# OAMT

The repository stores our implementations for the approach OAMT proposed in paper "Object Action Association based Metamorphic Testing for Image Caption Systems" 

## Requirements
```
python = 3.8

torch = 2.4.0

spacy = 3.7.2

transformers =4.44.0

cuda = 12.1

matplotlib==3.5.2

matplotlib-venn==0.11.7

numpy==1.23.1
```

## Data

We use the images  from **MS COCO 2017** dataset for Testing. You can download the dataset from the official COCO website:

- **Images**
    - [Train images (2017)](http://images.cocodataset.org/zips/train2017.zip)
    - [Validation images (2017)](http://images.cocodataset.org/zips/val2017.zip)
    - [Test images (2017, no annotations)](http://images.cocodataset.org/zips/test2017.zip)

After downloading, extract the files and organize them as follows:
```text
OAMT/
├── data/
│   ├── train2017/
│   ├── val2017/
│   ├── test2017/
```


## Test Object

we evaluate our approach on four representative IC models -- Blip, GIT, OFA and Oscar

For Blip and GIT, the models are from [HuggingFace](https://huggingface.co/), the code will automatically download the required models (Internet connection is required).

For testing OFA and Oscar:

Clone their official repositories into the OAA_extraction directory and Install additional dependencies:

```bash
cd OAA_extraction/
git clone https://github.com/OFA-Sys/OFA.git
git clone https://github.com/microsoft/Oscar.git
pip install -r OFA/requirements.txt
pip install -r Oscar/requirements.txt
```
Download models:

- OFA: Download caption_base_best from [OFA Model Zoo](https://github.com/OFA-Sys/OFA/blob/main/checkpoints.md)

- Oscar: Download coco_captioning_base_xe from [Oscar Model Hub](https://github.com/microsoft/Oscar/blob/master/VinVL_MODEL_ZOO.md)

## Usage

### RQ1:
Purpose: Evaluates integrity of images generated by Image Cutting

Requirements:

- Internet connection for model download

- ~1.5GB disk space

- Hugging Face access
```bash
python experiments/rq1/cropped_sample.py
python experiments/integrity.py
```
> **Note**: First run will download **facebook/detr-resnet-50** from Hugging Face. Monitor download progress in terminal.

Then the results will be saved in experiments/rq_results/integrity_score
### RQ2:
Purpose: report issues and precision

Requirements:

- Internet connection

- ~1.4GB disk space

- SpaCy English model
```bash
python -m spacy download en_core_web_sm
python experiments/rq2/report_issues.py
python experiments/rq2/Precision.py
```
>Key Details:
>- en_core_web_sm install: Required for text processing (run once)
>- First report_issues.py run downloads microsoft/deberta-large-mnli
>- Verify spaCy install: python -c "import spacy; assert spacy.util.is_package('en_core_web_sm')"

Then the results will be saved in experiments/rq_results/Precision and experiments/rq_results/issues
### RQ3:
Purpose: Collect statistics on the types of reported captioning errors
```bash
python experiments/rq3/categorys.py
```
Then the results will be saved in experiments/rq_results/error_distribution

### RQ4:
Purpose: Calculate the overlaps between OAMT and ROME
Requirements:

- Internet connection

- ~60GB disk space


```bash
git clone https://github.com/RobustNLP/TestIC.git
... #run ROME from the step of https://github.com/RobustNLP/TestIC/blob/main/ROME/README.md
python experiments/rq2/report_issues.py
python experiments/rq4/overlap.py
``` 
Then the results will be saved in experiments/rq_results/overlap.pdf

